___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "CookieScript CMP (Consent Mode)",
  "brand": {
    "id": "github.com_Cookie-Script",
    "displayName": "Cookie-Script",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "CookieScript is a Consent Management Platform that helps you comply with privacy regulations. This template is designed to properly integrate the CookieScript banner in GTM with Consent Mode support",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "script_src",
    "displayName": "Banner code URL",
    "simpleValueType": true,
    "notSetText": "Enter your script source URL. It can be found in your CookieScript account \u003e select Banner \u003e Installation tab. Example: https://cdn.cookie-script.com/s/xxxxxxxxxxxxxxxxxxxxxxxxx.js",
    "help": "Create an account at Cookie-Script.com, add a new banner and get script source in the Installations tab.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "https:\\/\\/(cdn|eu|ca|ca-eu|geo)\\.cookie-script.com\\/s\\/[0-9|a-f]{32}\\.js([\\?\u0026](region|country|state)\u003d[a-z/-]*)*"
        ]
      }
    ],
    "valueHint": "Your CookieScript banner script URL"
  },
  {
    "type": "CHECKBOX",
    "name": "iab_stub_enablead",
    "checkboxText": "Enable IAB TCF 2.2 integration",
    "simpleValueType": true,
    "help": "Preload IAB TCF files if you\u0027re having problems with ADs on your site. \u003ca href\u003d\"https://help.cookie-script.com/en/google-tag-manager/enable-iab-tcf\" target\u003d\"_blank\"\u003eRead more\u003c/a\u003e"
  },
  {
    "type": "GROUP",
    "name": "defaultconsent",
    "displayName": "Default Consent (Global)",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "defaultconsent_ad_storage",
        "displayName": "Advertisement Cookies [ad_storage]",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Enables storage (such as cookies) related to advertising"
      },
      {
        "type": "SELECT",
        "name": "defaultconsent_ad_user_data",
        "displayName": "Advertisement User Data [ad_user_data]",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Sets consent for sending user data to Google for advertising purposes."
      },
      {
        "type": "SELECT",
        "name": "defaultconsent_ad_personalization",
        "displayName": "Advertisement Personalization [ad_personalization]",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Controls whether data can be used for ads personalization (eg. remarketing)"
      },
      {
        "type": "SELECT",
        "name": "defaultconsent_analytics_storage",
        "displayName": "Analytics Cookies [analytics_storage]",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Enables storage (such as cookies) related to analytics e.g. visit duration"
      },
      {
        "type": "SELECT",
        "name": "defaultconsent_functionality_storage",
        "displayName": "Functional Cookies [functionality_storage]",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "ignore",
            "displayValue": "Ignore"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Enables storage that supports the functionality of the website or app e.g. language settings"
      },
      {
        "type": "SELECT",
        "name": "defaultconsent_personalization_storage",
        "displayName": "Personalization Cookies [personalization_storage]",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "ignore",
            "displayValue": "Ignore"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Enables storage related to personalization e.g. video recommendations"
      },
      {
        "type": "SELECT",
        "name": "defaultconsent_security_storage",
        "displayName": "Security cookies [security_storage]",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "denied",
            "displayValue": "Denied"
          },
          {
            "value": "ignore",
            "displayValue": "Ignore"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied",
        "help": "Enables storage related to security such as authentication functionality, fraud prevention, and other user protection"
      },
      {
        "type": "TEXT",
        "name": "wait_for_update",
        "displayName": "Wait for update",
        "simpleValueType": true,
        "defaultValue": 500,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "POSITIVE_NUMBER"
          }
        ]
      }
    ],
    "help": "Select what are the default consent state before user has selected his preferences."
  },
  {
    "type": "GROUP",
    "name": "regionconsentgroup",
    "displayName": "Default Consent (Region-specific)",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "regionconsent",
        "displayName": "",
        "paramTableColumns": [
          {
            "param": {
              "type": "SELECT",
              "name": "regionconsent_ad_storage",
              "displayName": "Advertisement Cookies [ad_storage]",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                }
              ],
              "simpleValueType": true,
              "help": "Enables storage (such as cookies) related to advertising"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "regionconsent_ad_user_data",
              "displayName": "Advertisement User Data [ad_user_data]",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                }
              ],
              "simpleValueType": true,
              "help": "Sets consent for sending user data to Google for advertising purposes."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "regionconsent_ad_personalization",
              "displayName": "Advertisement Personalization [ad_personalization]",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                }
              ],
              "simpleValueType": true,
              "help": "Controls whether data can be used for ads personalization (eg. remarketing)"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "regionconsent_analytics_storage",
              "displayName": "Analytics Cookies [analytics_storage]",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                }
              ],
              "simpleValueType": true,
              "help": "Enables storage (such as cookies) related to analytics e.g. visit duration"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "regionconsent_functionality_storage",
              "displayName": "Functional Cookies [functionality_storage]",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "ignore",
                  "displayValue": "Ignore"
                }
              ],
              "simpleValueType": true,
              "help": "Enables storage that supports the functionality of the website or app e.g. language settings"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "regionconsent_personalization_storage",
              "displayName": "Personalization Cookies [personalization_storage]",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "ignore",
                  "displayValue": "Ignore"
                }
              ],
              "simpleValueType": true,
              "help": "Enables storage related to personalization e.g. video recommendations"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "regionconsent_security_storage",
              "displayName": "Security cookies [security_storage]",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                },
                {
                  "value": "ignore",
                  "displayValue": "Ignore"
                }
              ],
              "simpleValueType": true,
              "help": "Enables storage related to security such as authentication functionality, fraud prevention, and other user protection"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Regions",
              "simpleValueType": true,
              "help": "A comma-separated array of region codes specifying which region the consent settings apply to. Region codes are expressed using country and/or subdivisions in \u003ca href\u003d\"https://en.wikipedia.org/wiki/ISO_3166-2\"\u003eISO 3166-2\u003c/a\u003e format, ex: US-CA",
              "valueValidators": [
                {
                  "type": "NON_EMPTY"
                },
                {
                  "type": "REGEX",
                  "args": [
                    "(?i)^\\s*([a-z]{2}(-[a-z0-9]{1,3})?\\s*)(,\\s*[a-z]{2}(-[a-z0-9]{1,3})?\\s*)*$"
                  ],
                  "errorMessage": "Invalid format, valid example: US-CA,LT,DA"
                }
              ]
            },
            "isUnique": false
          }
        ],
        "newRowButtonText": "Add region"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "other",
    "displayName": "Other Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "url_passthrough",
        "checkboxText": "Pass Ad Click information through URLs [url_passthrough]",
        "simpleValueType": true,
        "help": "Check this if you want internal links to pass advertising identifiers (\u003cstrong\u003egclid\u003c/strong\u003e, \u003cstrong\u003edclid\u003c/strong\u003e, \u003cstrong\u003egclsrc\u003c/strong\u003e, \u003cstrong\u003e_gl\u003c/strong\u003e) in the link URL while waiting for consent to be granted."
      },
      {
        "type": "CHECKBOX",
        "name": "ads_data_redaction",
        "checkboxText": "Redact Ads Data [ads_data_redaction]",
        "simpleValueType": true,
        "help": "If this is checked \u003cstrong\u003eand\u003c/strong\u003e Advertising consent status is \u003cstrong\u003edenied\u003c/strong\u003e, Google\u0027s advertising tags will drop all advertising identifiers from the requests, and traffic will be routed through cookieless domains."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const setDefaultConsentState = require('setDefaultConsentState');
const gtagSet = require("gtagSet");

const updateConsentState = require('updateConsentState');
const JSON = require('JSON');
const decode = require('decodeUriComponent');
const getCookieValues = require('getCookieValues');
const Object = require('Object');
const setInWindow = require('setInWindow');

let scriptSrc = data.script_src;
const regionConsents = data.regionconsent || [];

//advanced settings
gtagSet({
  ads_data_redaction: !!data.ads_data_redaction,
  url_passthrough: !!data.url_passthrough,
  "developer_id.dMmY1Mm": true,
});

//default consent - Global
const defaultConsentState = {
  ad_storage: data.defaultconsent_ad_storage,
  analytics_storage: data.defaultconsent_analytics_storage,
  ad_user_data: data.defaultconsent_ad_user_data,
  ad_personalization: data.defaultconsent_ad_personalization,
  wait_for_update: data.wait_for_update,
};

if(data.defaultconsent_functionality_storage !== 'ignore') {
  defaultConsentState.functionality_storage = data.defaultconsent_functionality_storage;
}

if(data.defaultconsent_personalization_storage !== 'ignore') {
  defaultConsentState.personalization_storage = data.defaultconsent_personalization_storage;
}

if(data.defaultconsent_security_storage !== 'ignore') {
  defaultConsentState.security_storage = data.defaultconsent_security_storage;
}

setDefaultConsentState(defaultConsentState);

//Region specific
for (let index = 0; index < regionConsents.length; index++) {
  const regionConsent = regionConsents[index];
  const currentRegions = regionConsent.region
  .split(",")
  .map((region) => region.trim())
  .filter((region) => region);

  const consentRegionData = {
    ad_storage: regionConsent.regionconsent_ad_storage,
    analytics_storage: regionConsent.regionconsent_analytics_storage,
    ad_user_data: regionConsent.regionconsent_ad_user_data,
    ad_personalization: regionConsent.regionconsent_ad_personalization,
    region: currentRegions,
    wait_for_update: data.wait_for_update
  };

  if(regionConsent.regionconsent_functionality_storage !== 'ignore') {
    consentRegionData.functionality_storage = regionConsent.regionconsent_functionality_storage;
  }
  
  if(regionConsent.regionconsent_personalization_storage !== 'ignore') {
    consentRegionData.personalization_storage = regionConsent.regionconsent_personalization_storage;
  }
  
  if(regionConsent.regionconsent_security_storage!== 'ignore') {
    consentRegionData.security_storage = regionConsent.regionconsent_security_storage;
  }
  setDefaultConsentState(consentRegionData);
}



//update if user has already selected 
const cookieName = 'CookieScriptConsent';
let cookieVal;
let categories = [];

if (queryPermission('get_cookies', cookieName)) {
  cookieVal = getCookieValues(cookieName);
  if (cookieVal && cookieVal.length > 0) {
  	let consentCookie = cookieVal[0].toLowerCase();
    consentCookie = decode(consentCookie);
    consentCookie = JSON.parse(consentCookie);
    const updateState = {};
    if(consentCookie.googleconsentmap && consentCookie.action) {
      Object.keys(consentCookie.googleconsentmap).forEach(function(key) {
        const value = consentCookie.googleconsentmap[key];
        if(value !== 'ignore') {
          updateState[key] = 'denied';
        }
      });
      if(consentCookie.action === 'accept') {
        if(consentCookie.categories !== undefined) {
          categories = consentCookie.categories;
          categories = JSON.parse(categories);
        }
        if(categories.length > 0) {
          categories.forEach(function(category) {
            Object.keys(updateState).forEach(function(key) {
              const value = consentCookie.googleconsentmap[key];
              if(value === category) {
                updateState[key] = 'granted';
              }
            });
          }); 
        } else {
           Object.keys(updateState).forEach(function(key) {
              updateState[key] = 'granted';
            });
        }         
      }
      
      updateConsentState(updateState);
    }
  }
}


if (queryPermission('access_globals', 'readwrite', 'CookieScriptData'))
{
  const validTrigger = data.gtmEventId === -1;
  setInWindow('CookieScriptData', {
    useGoogleTemplate: true,
    isVerifyGoogleConsentMode: validTrigger
  }, true);
}

//Include IAB stabs if IAB is enabled
if(data.iab_stub_enablead) {
  if (queryPermission('inject_script', scriptSrc)) {
     injectScript('https://cookie-script.com/iabtcf/2.2/iab_stub.js', data.gtmOnSuccess(), data.gtmOnFailure);
  }
}


if (queryPermission('inject_script', scriptSrc)) {
  injectScript(scriptSrc, data.gtmOnSuccess(), data.gtmOnFailure);
} else {
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.cookie-script.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "CookieScriptConsent"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "developer_id.dMmY1Mm"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "CookieScriptData"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 3/29/2022, 7:02:22 PM


